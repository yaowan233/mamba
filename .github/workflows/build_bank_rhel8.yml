name: Build for Bank (RHEL8/GLIBC2.28)

on:
  workflow_dispatch:
    inputs:
      # 1. 代码分支：如果你不知道填什么，就保持 main
      git_ref:
        description: "Branch or Tag (e.g., main, v2.2.4)"
        required: true
        default: "main"
      
      # 2. Python 版本：银行用的是 3.12
      python_version:
        description: "Python Version"
        required: true
        default: "3.12"
      
      # 3. PyTorch 版本：根据你刚才的信息，填 2.7.0 或 2.10.0
      torch_version:
        description: "PyTorch Version (e.g., 2.7.0, 2.10.0)"
        required: true
        default: "2.7.0"
      
      # 4. CUDA 版本：银行是 12.6
      cuda_version:
        description: "CUDA Version (e.g., 126)"
        required: true
        default: "126"

jobs:
  build_wheel:
    name: Build on UBI8 Container
    runs-on: ubuntu-latest
    
    # ★★★ 核心关键点 ★★★
    # 使用 NVIDIA 官方的 UBI8 (Universal Base Image 8) 镜像
    # 这个镜像基于 RHEL 8，底层 GLIBC 版本就是 2.28
    # 只要在这里面编译成功，拿到银行里绝对能跑！
    container:
      image: nvidia/cuda:12.6.0-devel-ubi8
      
    steps:
      - name: 1. Install System Tools
        run: |
          # UBI8 镜像比较精简，需要安装基础工具
          dnf install -y git wget tar gzip gcc gcc-c++ which
          
      - name: 2. Install Miniconda
        run: |
          # 安装 Conda 以便获得纯净的 Python 3.12 环境
          wget https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh -O miniconda.sh
          bash miniconda.sh -b -p /opt/miniconda
          echo "/opt/miniconda/bin" >> $GITHUB_PATH

      - name: 3. Setup Python & PyTorch
        run: |
          source /opt/miniconda/bin/activate
          conda create -n build_env python=${{ inputs.python_version }} -y
          conda activate build_env
          
          echo "Installing PyTorch ${{ inputs.torch_version }}..."
          
          # 使用官方源安装 PyTorch
          pip install torch==${{ inputs.torch_version }} --index-url https://download.pytorch.org/whl/cu${{ inputs.cuda_version }}
          
          # 安装编译 Mamba 必须的构建工具
          pip install packaging ninja wheel setuptools

      - name: 4. Checkout Code
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.git_ref }}

      - name: 5. Build Wheel (Local Compile)
        env:
          # 强制本地编译，不联网下载
          MAMBA_FORCE_BUILD: "TRUE"
          # 除非银行是自己编译的 PyTorch，否则通常不需要开启 CXX11 ABI
          MAMBA_FORCE_CXX11_ABI: "FALSE"
          # 显卡架构：适配主流高性能卡 (A100, H100, Blackwell等)
          TORCH_CUDA_ARCH_LIST: "8.0 8.6 9.0"
        run: |
          source /opt/miniconda/bin/activate build_env
          
          echo "Starting build..."
          # 验证编译器版本
          nvcc --version
          
          # 开始编译 (生成 whl 文件到 dist 目录)
          pip wheel . --no-deps -w dist/ --verbose

      - name: 6. Verify GLIBC Version
        run: |
          # 打印一下当前的 GLIBC 版本，让你放心
          ldd --version || true
          rpm -q glibc
          ls -l dist/

      - name: 7. Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: mamba-bank-rhel8-wheel
          path: dist/*.whl
