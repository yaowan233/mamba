name: Build for Bank (RHEL8/GLIBC2.28)

on:
  workflow_dispatch:
    inputs:
      git_ref:
        description: "Branch or Tag (e.g., main, v2.2.4)"
        required: true
        default: "main"
      python_version:
        description: "Python Version"
        required: true
        default: "3.12"
      torch_version:
        description: "PyTorch Version"
        required: true
        default: "2.7.0"
      cuda_version:
        description: "CUDA Version (e.g., 126)"
        required: true
        default: "126"

jobs:
  build_wheel:
    name: Build on UBI8 Container
    runs-on: ubuntu-latest
    
    container:
      image: nvidia/cuda:12.6.0-devel-ubi8
      options: --user root  # 确保有权限清理文件
      
    steps:
      - name: 1. Install System Tools
        run: |
          dnf install -y git wget tar gzip gcc gcc-c++ which
          dnf clean all  # 清理 dnf 缓存
          
      - name: 2. Install Miniconda
        run: |
          wget https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh -O miniconda.sh
          bash miniconda.sh -b -p /opt/miniconda
          rm miniconda.sh  # 删除安装包释放空间
          echo "/opt/miniconda/bin" >> $GITHUB_PATH

      - name: 3. Setup Python & PyTorch
        run: |
          source /opt/miniconda/bin/activate
          conda create -n build_env python=${{ inputs.python_version }} -y
          conda activate build_env
          
          echo "Installing PyTorch ${{ inputs.torch_version }}..."
          
          # 安装 PyTorch
          pip install torch==${{ inputs.torch_version }} --index-url https://download.pytorch.org/whl/cu${{ inputs.cuda_version }}
          
          # 安装构建工具
          pip install packaging ninja wheel setuptools
          
          # ★★★ 关键操作：清理 pip 缓存以释放数 GB 空间 ★★★
          pip cache purge
          rm -rf ~/.cache/pip

      - name: 4. Checkout Code
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.git_ref }}

      - name: 5. Build Wheel (Local Compile)
        env:
          MAMBA_FORCE_BUILD: "TRUE"
          MAMBA_FORCE_CXX11_ABI: "FALSE"
          TORCH_CUDA_ARCH_LIST: "8.0 8.6 9.0"
        run: |
          source /opt/miniconda/bin/activate build_env
          
          echo "Starting build..."
          nvcc --version
          
          # ★★★ 关键修改：添加 --no-build-isolation ★★★
          # 这告诉 pip：直接使用当前环境（build_env）里的 PyTorch，不要再去创建一个临时环境重装一遍
          pip wheel . --no-deps --no-build-isolation -w dist/ --verbose

      - name: 6. Verify and Upload
        run: |
          ls -l dist/
          rpm -q glibc

      - name: 7. Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: mamba-bank-rhel8-wheel
          path: dist/*.whl
