name: Build for Bank (RHEL8/GLIBC2.28/GCC11) - FINAL

on:
  workflow_dispatch:
    inputs:
      git_ref:
        description: "Branch or Tag (e.g., main, v2.2.4)"
        required: true
        default: "main"
      python_version:
        description: "Python Version"
        required: true
        default: "3.12"
      torch_version:
        description: "PyTorch Version"
        required: true
        default: "2.7.0"
      cuda_version:
        description: "CUDA Version (e.g., 126)"
        required: true
        default: "126"

jobs:
  build_wheel:
    name: Build on UBI8 Container
    runs-on: ubuntu-latest
    
    container:
      image: nvidia/cuda:12.6.0-devel-ubi8
      options: --user root
      
    steps:
      - name: 1. Enable CRB Repo & Install GCC 11
        run: |
          # ★★★ 关键修复 ★★★
          # 启用 CodeReady Builder (CRB) 仓库，否则找不到 gcc-toolset
          dnf install -y 'dnf-command(config-manager)'
          dnf config-manager --set-enabled crb
          
          # 现在可以安装 GCC 11 和其他工具了
          dnf install -y gcc-toolset-11 git wget tar gzip which
          
          # 清理缓存释放空间
          dnf clean all

      - name: 2. Install Miniconda
        run: |
          wget https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh -O miniconda.sh
          bash miniconda.sh -b -p /opt/miniconda
          rm miniconda.sh
          echo "/opt/miniconda/bin" >> $GITHUB_PATH

      - name: 3. Setup Python & PyTorch
        run: |
          source /opt/miniconda/bin/activate
          conda create -n build_env python=${{ inputs.python_version }} -y
          conda activate build_env
          
          echo "Installing PyTorch ${{ inputs.torch_version }}..."
          pip install torch==${{ inputs.torch_version }} --index-url https://download.pytorch.org/whl/cu${{ inputs.cuda_version }}
          pip install packaging ninja wheel setuptools
          
          pip cache purge
          rm -rf ~/.cache/pip

      - name: 4. Checkout Code
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.git_ref }}

      - name: 5. Build Wheel (GCC 11 Enabled)
        env:
          MAMBA_FORCE_BUILD: "TRUE"
          MAMBA_FORCE_CXX11_ABI: "FALSE"
          TORCH_CUDA_ARCH_LIST: "8.0 8.6 9.0"
        run: |
          source /opt/miniconda/bin/activate build_env
          
          # 激活 GCC 11 环境
          source /opt/rh/gcc-toolset-11/enable
          
          echo "Checking Compiler Versions:"
          gcc --version
          nvcc --version
          
          echo "Starting Build..."
          pip wheel . --no-deps --no-build-isolation -w dist/ --verbose

      - name: 6. Verify and Upload
        run: |
          ls -l dist/
          rpm -q glibc

      - name: 7. Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: mamba-bank-rhel8-final-wheel
          path: dist/*.whl
