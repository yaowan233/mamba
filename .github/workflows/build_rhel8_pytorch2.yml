name: Build Mamba (RHEL8 | PyTorch 2.x | CUDA 12.x)

on:
  workflow_dispatch:
    inputs:
      mamba_ref:
        description: "Mamba Git Ref (tag/branch)"
        required: true
        default: "v2.2.4"  # 请修改为你需要的 mamba 版本
      python_version:
        description: "Python Version"
        required: true
        default: "3.12"
      torch_version:
        description: "PyTorch Version (e.g. 2.7.0, 2.10.0)"
        required: true
        default: "2.7.0"   # 这里填你内网实际用的版本
      cuda_version:
        description: "CUDA Version for PyTorch URL (e.g. 126, 128)"
        required: true
        default: "126"     # 对应 cu126

jobs:
  build_wheel:
    name: Build on UBI 8 (GLIBC 2.28)
    runs-on: ubuntu-latest
    
    # ★关键点：使用 NVIDIA 官方的 CUDA 12.6 开发版 UBI8 镜像
    # 这确保了：
    # 1. 编译出的包兼容 RedHat 8.4 (GLIBC 2.28)
    # 2. 拥有 nvcc 12.6 编译器
    container:
      image: nvidia/cuda:12.6.0-devel-ubi8
      
    steps:
      - name: Install System Dependencies
        run: |
          # UBI8 使用 dnf 包管理器
          dnf install -y git wget tar gzip gcc gcc-c++ which
          
      - name: Install Miniconda (Get Python ${{ inputs.python_version }})
        run: |
          # 安装 Conda 以获取纯净的 Python 环境
          wget https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh -O miniconda.sh
          bash miniconda.sh -b -p /opt/miniconda
          echo "/opt/miniconda/bin" >> $GITHUB_PATH

      - name: Create Build Environment
        run: |
          source /opt/miniconda/bin/activate
          conda create -n build_env python=${{ inputs.python_version }} -y

      - name: Install PyTorch ${{ inputs.torch_version }} (cu${{ inputs.cuda_version }})
        run: |
          source /opt/miniconda/bin/activate build_env
          
          echo "Installing PyTorch from official index..."
          
          # 根据你提供的截图，使用最新的 index-url 格式
          # 例如：https://download.pytorch.org/whl/cu126
          pip install torch==${{ inputs.torch_version }} torchvision --index-url https://download.pytorch.org/whl/cu${{ inputs.cuda_version }}
          
          # 安装构建工具
          pip install packaging ninja wheel setuptools

      - name: Checkout Mamba Source
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.mamba_ref }}

      - name: Build Mamba Wheel
        env:
          # 强制本地编译
          MAMBA_FORCE_BUILD: "TRUE"
          # 除非你内网是自己编译的 PyTorch，否则 pip 安装版通常不需要 CXX11_ABI=TRUE
          MAMBA_FORCE_CXX11_ABI: "FALSE" 
          # 针对较新的显卡 (根据 2026 年的主流显卡配置)
          # 8.0(A100), 8.6(3090/A10), 8.9(4090/L40), 9.0(H100), 10.0(Blackwell)
          TORCH_CUDA_ARCH_LIST: "8.0 8.6 8.9 9.0+PTX"
        run: |
          source /opt/miniconda/bin/activate build_env
          
          echo "Starting Build..."
          echo "NVCC Version:"
          nvcc --version
          
          # 开始构建
          pip wheel . --no-deps -w dist/ --verbose

      - name: Check GLIBC Compatibility
        run: |
          echo "Checking GLIBC requirements..."
          # 简单验证，确保是在 UBI8 环境下生成的
          rpm -q glibc
          ls -l dist/

      - name: Upload Wheel
        uses: actions/upload-artifact@v4
        with:
          name: mamba-rhel8-cu${{ inputs.cuda_version }}-wheel
          path: dist/*.whl
